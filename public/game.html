<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>룸 채팅 및 게임 테스트</title>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        /* 전체 컨테이너: 채팅과 방 인원 목록을 좌우로 배치 (7:3 비율) */
        .container {
            display: flex;
            gap: 10px;
        }

        .chat-container {
            flex: 7;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .occupant-container {
            flex: 3;
            border: 1px solid #ccc;
            padding: 10px;
        }

        #chatMessages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 5px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }

        #occupantList {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        #occupantList div {
            border: 1px solid #aaa;
            padding: 5px;
            text-align: center;
            background-color: #fff;
            height: 70px;
        }

        .system-message {
            color: green;
            font-weight: bold;
        }

        .role-message {
            color: blue;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>룸 채팅 테스트</h1>
    <!-- 사용자 ID 입력 -->
    <div>
        <label for="userId">사용자 ID: </label>
        <input type="number" id="userId" placeholder="1">
        <button id="loginBtn">로그인 (룸 입장)</button>
    </div>
    <!-- 전체 컨테이너 -->
    <div class="container" id="mainContainer" style="display: none;">
        <!-- 채팅 영역 -->
        <div class="chat-container" id="chatRoom">
            <h2 id="roomTitle"></h2>
            <div id="chatMessages"></div>
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
            <button id="sendBtn">전송</button>
        </div>
        <!-- 방 접속 인원 영역 -->
        <div class="occupant-container" id="roomOccupants">
            <h2>현재 접속 인원</h2>
            <div id="occupantList"></div>
        </div>
    </div>
    <!-- 게임 상태 영역 -->
    <div id="gameSection" style="display: none; margin-top: 20px;">
        <h2>게임 상태</h2>
        <div id="gameStatus"></div>
    </div>
    <script>
        // 방 ID 추출 (예: http://localhost:3000/room/1)
        var pathSegments = window.location.pathname.split('/');
        var roomId = pathSegments[pathSegments.length - 1];
        document.getElementById('roomTitle').textContent = "채팅룸 (룸 " + roomId + ")";

        var currentUserId;
        var socket;      // 단일 소켓
        var roomInfo;    // ROOM:JOINED 또는 ROOM:UPDATED 이벤트로 최신 방 정보 수신

        document.getElementById("loginBtn").addEventListener("click", function () {
            var userIdInput = document.getElementById("userId").value;
            if (!userIdInput) {
                alert("사용자 ID를 입력하세요.");
                return;
            }
            currentUserId = Number(userIdInput);

            // 단일 소켓 생성 (auth 옵션 사용)
            socket = io("http://localhost:3000/room", {
                auth: { roomId: roomId, userId: currentUserId }
            });

            // UI 표시
            document.getElementById("mainContainer").style.display = "flex";
            document.getElementById("gameSection").style.display = "block";

            // 방 입장 요청
            socket.emit("joinRoom", { roomId: roomId, userId: currentUserId });

            // ROOM:JOINED 이벤트 (초기 방 정보)
            socket.once("ROOM:JOINED", function (data) {
                roomInfo = data;
                console.log("방 정보 (JOINED):", roomInfo);
                updateOccupantList(roomInfo);
            });

            // ROOM:UPDATED 이벤트 (실시간 방 정보 업데이트)
            socket.on("ROOM:UPDATED", function (data) {
                roomInfo = data;
                console.log("방 정보 (UPDATED):", roomInfo);
                updateOccupantList(roomInfo);
            });

            // 채팅 메시지 수신
            socket.on("message", function (data) {
                appendChatMessage("[" + data.sender + "] " + data.message);
            });

            document.getElementById("sendBtn").addEventListener("click", sendChatMessage);

            // 게임 이벤트 YOUR_ROLE 수신
            socket.on("YOUR_ROLE", function (data) {
                console.log("YOUR_ROLE 이벤트 수신:", data);
                appendChatMessage(data.message, true);
            });

            socket.on("error", function (data) {
                alert("게임 에러: " + data.message);
            });
        });

        // 채팅 메시지 추가 함수
        function appendChatMessage(message, isRole) {
            var chatMessagesDiv = document.getElementById("chatMessages");
            var messageElement = document.createElement("div");
            if (isRole) {
                messageElement.className = "role-message";
            }
            messageElement.textContent = message;
            chatMessagesDiv.appendChild(messageElement);
        }

        // 채팅 메시지 전송 함수
        function sendChatMessage() {
            var messageInputElem = document.getElementById("messageInput");
            var message = messageInputElem ? messageInputElem.value : "";
            if (message.trim() === "") return;
            socket.emit("chatMessage", { roomId: roomId, userId: currentUserId, message: message });
            if (messageInputElem) {
                messageInputElem.value = "";
            }
        }

        // 방 접속 인원 업데이트 함수
        function updateOccupantList(roomData) {
            var occupantListDiv = document.getElementById("occupantList");
            occupantListDiv.innerHTML = ""; // 기존 목록 초기화
            var players = [];
            try {
                players = typeof roomData.players === "string" ? JSON.parse(roomData.players) : roomData.players;
            } catch (error) {
                players = [];
            }
            // 2열 그리드로 플레이어 목록 표시
            players.forEach(function (player) {
                var item = document.createElement("div");
                item.textContent = "사용자 " + player.id;
                occupantListDiv.appendChild(item);
            });
        }
    </script>
</body>

</html>