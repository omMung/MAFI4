<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>게임 로비</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        text-align: center;
      }
      .container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .room-list {
        margin-top: 20px;
      }
      .room-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border: 1px solid #ddd;
        margin-bottom: 5px;
        background: #f9f9f9;
      }
      .room-item button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
      }
      .room-item button:hover {
        background-color: #218838;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>게임 로비</h2>
      <button onclick="fetchRooms()">새로고침</button>
      <div class="room-list" id="roomList"></div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', fetchRooms);

      function fetchRooms() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
          alert('로그인 후 이용해주세요.');
          window.location.href = 'index.html';
          return;
        }

        fetch('http://localhost:3000/api/rooms', {
          method: 'GET',
          headers: { Authorization: token },
          credentials: 'include',
        })
          .then((response) => {
            if (response.status === 401) {
              return refreshAccessToken().then(() => fetchRooms());
            } else if (!response.ok) {
              throw new Error('서버 오류');
            }
            return response.json();
          })
          .then((data) => updateRoomList(data.rooms))
          .catch((error) =>
            console.error('방 목록을 가져오는 중 오류 발생:', error),
          );
      }

      function updateRoomList(rooms) {
        const roomList = document.getElementById('roomList');
        roomList.innerHTML = '';

        rooms.forEach((room) => {
          const roomElement = document.createElement('div');
          roomElement.className = 'room-item';
          roomElement.innerHTML = `
                    <span>${room.roomName} | ${room.status} | 인원 ${room.playerCount}/8</span>
                    <button onclick="joinRoom(${room.roomId})">입장</button>
                `;
          roomList.appendChild(roomElement);
        });
      }

      function refreshAccessToken() {
        return fetch('http://localhost:3000/api/auth/refresh', {
          method: 'POST',
          credentials: 'include',
        })
          .then((response) => {
            if (!response.ok) throw new Error('리프레시 토큰 만료');
            return response.json();
          })
          .then((data) => localStorage.setItem('accessToken', data.accessToken))
          .catch((error) => {
            alert('세션이 만료되었습니다. 다시 로그인해주세요.');
            localStorage.removeItem('accessToken');
            window.location.href = 'http://localhost:3000/index.html';
          });
      }

      function joinRoom(roomId) {
        const token = localStorage.getItem('accessToken');

        fetch(`http://localhost:3000/api/rooms/${roomId}`, {
          method: 'GET',
          headers: { Authorization: token },
          credentials: 'include',
        })
          .then((response) => {
            if (!response.ok) throw new Error('방 입장 실패');
            return response.json();
          })
          .then((data) => {
            localStorage.setItem('userId', data.userId);
            window.location.href = `http://localhost:3000/room.html?roomId=${roomId}`;
          })
          .catch((error) => {
            alert(error.message);
            console.error('방 입장 오류:', error);
          });
      }
    </script>
  </body>
</html>
