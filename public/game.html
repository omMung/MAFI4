<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê²Œì„ ë¡œë¹„</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        text-align: center;
      }
      .container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .room-list {
        margin-top: 20px;
      }
      .room-item {
        display: flex;
        flex-direction: column; /* âœ… ë°© ì •ë³´ë¥¼ ì„¸ë¡œ ì •ë ¬ */
        align-items: flex-start; /* âœ… ì™¼ìª½ ì •ë ¬ */
        padding: 10px;
        border: 1px solid #ddd;
        margin-bottom: 5px;
        background: #f9f9f9;
      }

      .room-item span {
        font-weight: bold;
        margin-bottom: 5px; /* âœ… ë°© ì´ë¦„ê³¼ ìƒíƒœ ì •ë³´ ê°„ê²© ì¡°ì ˆ */
      }

      .room-item .room-info {
        font-size: 14px;
        color: #555;
      }

      .room-item button {
        align-self: flex-end; /* âœ… ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ ì •ë ¬ */
        background-color: #28a745;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        margin-top: 5px; /* âœ… ë²„íŠ¼ê³¼ í…ìŠ¤íŠ¸ ê°„ê²© ì¡°ì ˆ */
      }

      .room-item button:hover {
        background-color: #218838;
      }

      /* âœ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 10;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        padding: 20px;
        width: 300px;
        border-radius: 8px;
        text-align: left;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .modal-content h2 {
        margin-bottom: 10px;
        text-align: center;
      }

      .modal-content input,
      .modal-content select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .checkbox-container {
        display: flex;
        align-items: center;
        justify-content: space-between; /* ë¹„ë°€ë°© ì™¼ìª½, ì²´í¬ë°•ìŠ¤ ì˜¤ë¥¸ìª½ */
        width: 100%;
        margin-bottom: 10px;
        padding: 5px 0; /* ê°„ê²© ì¡°ì ˆ */
      }

      .checkbox-container label {
        font-size: 16px;
        font-weight: bold;
        white-space: nowrap; /* âœ… ë‘ ì¤„ë¡œ ì•ˆ ë‚˜ë‰˜ê²Œ ì„¤ì • */
      }

      .checkbox-container input {
        transform: scale(1.2); /* ì²´í¬ë°•ìŠ¤ í¬ê¸° ì¡°ì ˆ */
        margin-left: 10px; /* ê°„ê²© ì¡°ì • */
      }

      .modal-content button {
        width: 100%;
        padding: 10px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      .close-btn {
        background: red;
        color: white;
      }

      .create-btn {
        background: #007bff;
        color: white;
      }

      .create-btn:hover {
        background: #0056b3;
      }

      .close-btn:hover {
        background: darkred;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ê²Œì„ ë¡œë¹„</h2>
      <input
        type="text"
        id="searchRoom"
        placeholder="ë°© ì´ë¦„ ê²€ìƒ‰..."
        oninput="searchRooms()"
      />

      <button onclick="openModal()">ë°© ìƒì„±</button>
      <button onclick="fetchRooms()">ìƒˆë¡œê³ ì¹¨</button>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      <!-- âœ… ë°© ìƒì„± ëª¨ë‹¬ -->
      <div id="roomModal" class="modal">
        <div class="modal-content">
          <h2>ë°© ìƒì„±</h2>
          <label>ë°© ì´ë¦„</label>
          <input type="text" id="roomName" placeholder="ë°© ì´ë¦„ ì…ë ¥" />

          <label>ëª¨ë“œ ì„ íƒ</label>
          <select id="roomMode">
            <option value="6ì¸ìš© ëª¨ë“œ">6ì¸ìš© ëª¨ë“œ</option>
            <option value="8ì¸ìš© ëª¨ë“œ">8ì¸ìš© ëª¨ë“œ</option>
          </select>
          <div class="checkbox-container">
            <label for="isPrivate">ë¹„ë°€ë°©</label>
            <input type="checkbox" id="isPrivate" />
          </div>
          <input
            type="password"
            id="roomPassword"
            placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ì„ íƒ)"
            disabled
          />

          <button class="create-btn" onclick="createRoom()">ë°© ìƒì„±</button>
          <button class="close-btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="room-list" id="roomList"></div>
    </div>
    <script src="./js/config.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        checkTokenExpiration();
        fetchRooms();
      });

      function checkTokenExpiration() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = 'index.html';
          return;
        }
      }

      function fetchRooms() {
        let token = localStorage.getItem('accessToken');

        fetch(`${CONFIG.API_BASE_URL}/api/rooms`, {
          method: 'GET',
          headers: { Authorization: token },
          credentials: 'include',
        })
          .then((response) => {
            if (response.status === 401) {
              console.log(
                'ğŸ”„ ë°© ëª©ë¡ ì¡°íšŒ ì¤‘ ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œë¨. ë¦¬í”„ë ˆì‹œ ì‹œë„',
              );

              // âœ… refresh í›„ ìµœì‹  í† í°ìœ¼ë¡œ ë‹¤ì‹œ ìš”ì²­
              return refreshAccessToken().then((newToken) => {
                return fetch(`${CONFIG.API_BASE_URL}/api/rooms`, {
                  method: 'GET',
                  headers: { Authorization: newToken },
                  credentials: 'include',
                });
              });
            } else if (!response.ok) {
              throw new Error('ì„œë²„ ì˜¤ë¥˜');
            }
            return response.json();
          })
          .then((data) => updateRoomList(data.rooms))
          .catch((error) =>
            console.error('ë°© ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error),
          );
      }

      function updateRoomList(rooms) {
        const roomList = document.getElementById('roomList');
        roomList.innerHTML = '';

        rooms.forEach((room) => {
          const roomElement = document.createElement('div');
          roomElement.className = 'room-item';
          roomElement.innerHTML = `
      <span>${room.roomName}</span>
      <div class="room-info">${room.status} | ì¸ì› ${room.playerCount}/8</div>
      <button onclick="joinRoom(${room.roomId})">ì…ì¥</button>
    `;
          roomList.appendChild(roomElement);
        });
      }

      function refreshAccessToken() {
        return fetch(`${CONFIG.API_BASE_URL}/api/auth/refresh`, {
          method: 'POST',
          credentials: 'include', // âœ… ì¿ í‚¤ í¬í•¨í•˜ì—¬ ìš”ì²­
        })
          .then((response) => {
            console.log('âœ… response:', response); // ğŸ” ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            if (!response.ok) throw new Error('ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ');
            return response.json();
          })
          .then((data) => {
            console.log('âœ… ë°›ì€ ë°ì´í„°:', data); // ğŸ” ë¦¬í„´ëœ ë°ì´í„° í™•ì¸

            if (!data.accessToken) {
              throw new Error('ìƒˆë¡œìš´ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }

            console.log('âœ… ìƒˆë¡œìš´ accessToken:', data.accessToken);
            localStorage.setItem('accessToken', data.accessToken); // ğŸš€ ìƒˆë¡œìš´ ì•¡ì„¸ìŠ¤ í† í° ì €ì¥

            return data.accessToken; // ğŸš€ ë°˜í™˜í•˜ì—¬ ì¦‰ì‹œ ì‚¬ìš©
          })
          .catch((error) => {
            console.error('âŒ ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ:', error);
            if (confirm('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              logout(); // âœ… ì‚¬ìš©ìê°€ í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¡œê·¸ì•„ì›ƒ ì‹¤í–‰
            }
          });
      }

      function searchRooms() {
        const query = document.getElementById('searchRoom').value.trim();

        if (query === '') {
          fetchRooms(); // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ë°© ëª©ë¡ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
          return;
        }

        fetch(
          `${CONFIG.API_BASE_URL}/api/rooms/search?roomName=${encodeURIComponent(query)}`,
          {
            method: 'GET',
          },
        )
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            updateRoomList(data.rooms); // ê²€ìƒ‰ ê²°ê³¼ ì—…ë°ì´íŠ¸
          })
          .catch((error) => console.error('ë°© ê²€ìƒ‰ ì˜¤ë¥˜:', error));
      }

      function joinRoom(roomId) {
        let accessToken = localStorage.getItem('accessToken');

        fetch(`${CONFIG.API_BASE_URL}/api/rooms/${roomId}`, {
          method: 'GET',
          headers: { Authorization: accessToken },
          credentials: 'include',
        })
          .then((response) => {
            if (response.status === 401) {
              console.log('ğŸ”„ ë°© ì…ì¥ ì¤‘ ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œë¨. ë¦¬í”„ë ˆì‹œ ì‹œë„');

              // âœ… refresh í›„ ìµœì‹  í† í°ìœ¼ë¡œ ë‹¤ì‹œ ìš”ì²­
              return refreshAccessToken().then((newToken) => {
                console.log('ğŸ”„ ìƒˆ accessTokenìœ¼ë¡œ ì¬ìš”ì²­:', newToken);
                return fetch(`${CONFIG.API_BASE_URL}/api/rooms/${roomId}`, {
                  method: 'GET',
                  headers: { Authorization: newToken }, // âœ… ìµœì‹  í† í° ì ìš©
                  credentials: 'include',
                });
              });
            } else if (!response.ok) {
              throw new Error('ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
            return response.json();
          })
          .then((data) => {
            localStorage.setItem('userId', data.userId);
            window.location.href = `${CONFIG.API_BASE_URL}/room.html?roomId=${roomId}`;
          })
          .catch((error) => {
            alert(error.message);
            console.error('ë°© ì…ì¥ ì˜¤ë¥˜:', error);
          });
      }

      function logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = `${CONFIG.API_BASE_URL}/index.html`;
      }
      function openModal() {
        document.getElementById('roomModal').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('roomModal').style.display = 'none';
      }

      document
        .getElementById('isPrivate')
        .addEventListener('change', function () {
          document.getElementById('roomPassword').disabled = !this.checked;
        });

      function createRoom() {
        const token = localStorage.getItem('accessToken');
        const roomName = document.getElementById('roomName').value.trim();
        const mode = document.getElementById('roomMode').value;
        const locked = document.getElementById('isPrivate').checked;
        const password = locked
          ? document.getElementById('roomPassword').value.trim()
          : null;

        if (!roomName) {
          alert('ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        fetch(`${CONFIG.API_BASE_URL}/api/rooms`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token,
          },
          credentials: 'include',
          body: JSON.stringify({ roomName, mode, locked, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(`'${roomName}' ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeModal();
            joinRoom(data.roomId); // âœ… ìƒì„±í•œ ë°©ìœ¼ë¡œ ìë™ ì…ì¥
          })
          .catch((error) => {
            alert(error.message);
            console.error('ë°© ìƒì„± ì˜¤ë¥˜:', error);
          });
      }
    </script>
  </body>
</html>
