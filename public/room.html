<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Î£∏ Ï±ÑÌåÖ Î∞è Í≤åÏûÑ ÌÖåÏä§Ìä∏</title>
    <!-- Î∂ÄÌä∏Ïä§Ìä∏Îû© CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        background-color: #f0f4f8;
        margin: 20px;
        color: #333;
        line-height: 1.6;
        transition: background-color 4s ease;
      }

      h1,
      h2 {
        color: #2c3e50;
      }

      .container-custom {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }

      .chat-container,
      .occupant-container,
      .login-container {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: background-color 4s ease;
      }

      .chat-container {
        flex: 7;
      }

      .occupant-container {
        flex: 3;
      }

      #chatMessages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 10px;
        background-color: #f9f9f9;
        margin-bottom: 10px;
        scroll-behavior: smooth;
      }

      #occupantList {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .occupant-btn {
        padding: 10px;
        border: none;
        border-radius: 5px;
        background-color: #ecf0f1;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .occupant-btn:hover {
        background-color: #d5dbdb;
      }

      .occupant-btn.selected {
        background-color: #3498db;
        color: white;
      }

      .occupant-btn.dead {
        background-color: #e74c3c;
        color: white;
      }

      input[type='text'],
      input[type='number'] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      .system-message {
        color: #27ae60;
        font-weight: bold;
      }

      .role-message {
        color: #2980b9;
        font-weight: bold;
      }

      .red-message {
        color: red;
      }

      .purple-message {
        color: purple;
      }

      #voteBtn,
      #executeBtn,
      #survivalBtn {
        margin-top: 10px;
        margin-right: 10px;
      }

      @keyframes blink {
        0% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }

        100% {
          opacity: 1;
        }
      }

      .blink {
        animation: blink 1s infinite;
      }

      @media (max-width: 768px) {
        .container-custom {
          flex-direction: column;
        }

        .chat-container,
        .occupant-container {
          width: 100%;
        }
      }

      #roleActionContainer {
        margin-top: 10px;
        text-align: center;
      }
      #roleActionContainer button {
        margin: 5px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition:
          background-color 0.3s ease,
          transform 0.3s ease;
      }
      #roleActionContainer button.btn-danger {
        background-color: #e74c3c;
        color: #fff;
      }
      #roleActionContainer button.btn-danger:hover {
        background-color: #c0392b;
        transform: scale(1.05);
      }
      #roleActionContainer button.btn-primary {
        background-color: #3498db;
        color: #fff;
      }
      #roleActionContainer button.btn-primary:hover {
        background-color: #2980b9;
        transform: scale(1.05);
      }
      #roleActionContainer button.btn-success {
        background-color: #2ecc71;
        color: #fff;
      }
      #roleActionContainer button.btn-success:hover {
        background-color: #27ae60;
        transform: scale(1.05);
      }
    </style>
  </head>

  <body>
    <!-- Ìó§ÎçîÏö© ÎπàÍ≥µÍ∞Ñ -->
    <!-- <div class="header-placeholder" style="height: 50px"></div>
    <div
      class="container-custom"
      id="mainContainer"
      style="display: none"
    ></div> -->

    <!-- Ï†ÑÏ≤¥ Ïª®ÌÖåÏù¥ÎÑà: Ï±ÑÌåÖÍ≥º Ï†ëÏÜç Ïù∏Ïõê ÏòÅÏó≠ -->
    <div class="container-custom" id="mainContainer" style="display: none">
      <!-- Ï±ÑÌåÖ ÏòÅÏó≠ -->
      <div class="chat-container" id="chatRoom">
        <h2 id="roomTitle"></h2>
        <div id="chatMessages"></div>
        <input
          type="text"
          id="messageInput"
          class="form-control"
          placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
        />
        <button id="sendBtn" class="btn btn-secondary mt-2">Ï†ÑÏÜ°</button>
      </div>
      <!-- Ï†ëÏÜç Ïù∏Ïõê ÏòÅÏó≠ -->
      <div class="occupant-container" id="roomOccupants">
        <h2>ÌòÑÏû¨ Ï†ëÏÜç Ïù∏Ïõê</h2>
        <div id="occupantList"></div>
        <div
          id="myOccupantDiv"
          style="
            margin-top: 10px;
            border-top: 2px solid #ddd;
            padding-top: 10px;
          "
        ></div>
        <div
          id="phaseTimerContainer"
          style="text-align: center; margin-top: 10px"
        >
          <span id="phaseTimer" style="font-size: 16px; color: gray"></span>
        </div>
        <!-- Ìà¨Ìëú ÌôïÏ†ï Î≤ÑÌäº Ïª®ÌÖåÏù¥ÎÑà (Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïà®ÍπÄ) -->
        <div id="firstVoteContainer" style="display: none; margin-top: 10px">
          <button id="voteBtn" class="btn btn-success">Ìà¨Ìëú ÌôïÏ†ï</button>
          <p id="voteStatus"></p>
        </div>
        <!-- 2Ï∞® Ìà¨Ìëú Î≤ÑÌäº Ïª®ÌÖåÏù¥ÎÑà -->
        <div id="secondVoteContainer" style="display: none">
          <button id="executeBtn" class="btn btn-danger">ÏÇ¨ÏÇ¥</button>
          <button id="survivalBtn" class="btn btn-info">ÏÉùÏ°¥</button>
        </div>

        <!-- Ïó≠Ìï†Î≥Ñ Îä•Î†• Î≤ÑÌäº Ïª®ÌÖåÏù¥ÎÑà -->
        <div id="roleActionContainer" style="display: none; margin-top: 10px">
          <button
            id="mafiaActionBtn"
            class="btn btn-danger"
            style="display: none"
          >
            Ï†úÍ±∞Ìï† ÎåÄÏÉÅ ÏÑ†ÌÉù
          </button>
          <button
            id="policeActionBtn"
            class="btn btn-primary"
            style="display: none"
          >
            Ï°∞ÏÇ¨Ìï† ÎåÄÏÉÅ ÏÑ†ÌÉù
          </button>
          <button
            id="doctorActionBtn"
            class="btn btn-success"
            style="display: none"
          >
            Î≥¥Ìò∏Ìï† ÎåÄÏÉÅ ÏÑ†ÌÉù
          </button>
        </div>
      </div>
    </div>

    <script src="./js/config.js"></script>
    <script>
      // Î∞© ID Ï∂îÏ∂ú (Ïòà: http://localhost:3000/room/1)
      function getRoomIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('roomId'); // 'roomId' ÌååÎùºÎØ∏ÌÑ∞ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
      }

      var roomId = getRoomIdFromUrl(); // roomId Ï∂îÏ∂ú
      // if (!roomId) {
      //   alert('Ïò¨Î∞îÎ•∏ Î∞© IDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
      //   window.location.href = `${CONFIG.API_BASE_URL}/game.html`; //  Î∞© ID ÏóÜÏúºÎ©¥ Î°úÎπÑÎ°ú Ïù¥Îèô
      // }

      document.getElementById('roomTitle').textContent =
        'Ï±ÑÌåÖÎ£∏ (Î£∏ ' + roomId + ')';

      var isVotingPhase = false;
      var currentUserId;
      var sender = { id: Number, role: String, isAlive: Boolean }; // Î∞úÏã†Ïûê Ï†ïÎ≥¥
      var socket; // Îã®Ïùº ÏÜåÏºì
      var roomInfo; // ÏµúÏã† Î∞© Ï†ïÎ≥¥
      var selectedTargetId = null; // 1Ï∞® Ìà¨Ìëú Ïãú ÏÑ†ÌÉùÎêú ÎåÄÏÉÅÏùò ID
      var mafiaBtn = document.getElementById('mafiaActionBtn');
      var policeBtn = document.getElementById('policeActionBtn');
      var doctorBtn = document.getElementById('doctorActionBtn');

      //ÌÉÄÏù¥Î®∏ Í¥ÄÎ†® Î°úÏßÅ
      // UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
      function updatePhaseTimer(phase, remainingTime) {
        const phaseTimerElement = document.getElementById('phaseTimer');

        if (!phaseTimerElement) {
          console.error('‚ùå phaseTimer ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå!');
          return;
        }

        // ÌÉÄÏù¥Î®∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        phaseTimerElement.textContent = `(${phase}) ‚è≥ ${remainingTime}Ï¥à`;
        phaseTimerElement.style.display = 'inline'; // ÌòπÏãú Ïà®Í≤®Ï†∏ ÏûàÏùÑ Í≤ΩÏö∞ Î≥¥Ïù¥ÎèÑÎ°ù ÏÑ§Ï†ï
      }

      // Î°úÍ∑∏Ïù∏ Î∞è Î£∏ ÏûÖÏû•

      window.onload = function () {
        const userId = localStorage.getItem('userId');

        if (!userId) {
          alert('Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
          window.location.href = `${CONFIG.API_BASE_URL}/index.html`;
          return; //
        }

        currentUserId = userId;

        socket = io(`${CONFIG.GAME_BASE_URL}/room`, {
          auth: { roomId: roomId, userId: currentUserId },
        });

        sender.role = 'player';
        sender.isAlive = true;

        // UI ÌëúÏãú
        document.getElementById('mainContainer').style.display = 'flex';
        //document.getElementById('gameSection').style.display = 'block';
        document.getElementById('firstVoteContainer').style.display = 'block';

        socket.emit('joinRoom', { roomId: roomId, userId: currentUserId });
        socket.emit('requestRoomInfo', { roomId: roomId });

        socket.once('ROOM:JOINED', function (data) {
          roomInfo = data;
          console.log('ROOM:JOINED ÏàòÏã†:', roomInfo);
          updateOccupantList(roomInfo);
        });

        socket.on('ROOM:UPDATED', function (data) {
          roomInfo = data;
          console.log('ROOM:UPDATED ÏàòÏã†:', roomInfo);
          updateOccupantList(roomInfo);
        });

        socket.on('message', function (data) {
          appendChatMessage('[' + data.sender + '] ' + data.message);
        });

        socket.on('CHAT:DEAD', function (data) {
          appendChatMessage(
            '[' + data.sender + '] ' + data.message,
            'CHAT:DEAD',
          );
        });

        socket.on('CHAT:MAFIA', function (data) {
          appendChatMessage(
            '[' + data.sender + '] ' + data.message,
            'CHAT:MAFIA',
          );
        });

        socket.on('updateTimer', (data) => {
          console.log('‚è≥ ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏:', data);
          updatePhaseTimer(data.phase, data.timerTime);
        });

        socket.on('voteSuccess', function (data) {
          appendChatMessage(
            '[' + data.voterId + '] ' + data.message,
            'voteSucess',
          );
          socket.off('voteSuccess');
        });

        socket.on('system_message', function (data) {
          appendChatMessage(`[Í≥µÏßÄ] ${data.message}`, 'system_message');
        });
        // VOTE:SURVIVAL Ïù¥Î≤§Ìä∏ ÏàòÏã† Ïãú 2Ï∞® Ìà¨Ìëú Î≤ÑÌäº ÌëúÏãú Î∞è ÎåÄÏÉÅ Î≤ÑÌäº blink Ï†ÅÏö©
        socket.on('VOTE:SURVIVAL', function (data) {
          console.log('VOTE:SURVIVAL Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          var winnerBtn = document.querySelector(
            `.occupant-btn[data-userid="${data.winnerId}"]`,
          );
          if (winnerBtn) {
            winnerBtn.classList.add('blink');
          }
          document.getElementById('firstVoteContainer').style.display = 'none';
          document.getElementById('secondVoteContainer').style.display =
            'block';
        });

        document
          .getElementById('sendBtn')
          .addEventListener('click', sendChatMessage);

        socket.on('YOUR_ROLE', function (data) {
          //currentUserRole = data.role;
          sender = data.sender;
          appendChatMessage(data.message, true);
          updateMyRole(sender.role);
        });

        function updateMyRole(role) {
          var myOccupantDiv = document.getElementById('myOccupantDiv');
          myOccupantDiv.innerHTML = ''; // Í∏∞Ï°¥ ÎÇ¥Ïö© Ï¥àÍ∏∞Ìôî

          var myBtn = document.createElement('button');
          myBtn.className = 'btn btn-secondary occupant-btn';
          myBtn.textContent = `üë§ ÎÇò (ÏÇ¨Ïö©Ïûê ${currentUserId}) - [${role}]`;
          myBtn.disabled = true;

          myOccupantDiv.appendChild(myBtn);
        }

        socket.on('error', function (data) {
          if (data.message === 'Î∞© ÏµúÎåÄ Ïù∏ÏõêÏóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§.') {
            alert('Î∞© ÏµúÎåÄ Ïù∏ÏõêÏóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§. Î°úÎπÑÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
            window.location.href = `${CONFIG.API_BASE_URL}/game.html`;
          } else {
            alert('Í≤åÏûÑ ÏóêÎü¨: ' + data.message);
          }
        });

        // ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ 1Ï∞® Ìà¨Ìëú Î≤ÑÌäº Î≥¥Ïù¥ÎùºÎäî Ïù¥Î≤§Ìä∏ ÏàòÏã† Ïãú Ï≤òÎ¶¨
        socket.on('VOTE:FIRST:ENABLE', function (data) {
          isVotingPhase = true;
          document.getElementById('firstVoteContainer').style.display = 'block';
          voteBtn.disabled = false;
          executeBtn.disabled = false;
          survivalBtn.disabled = false;
          voteBtn.classList.remove('disabled=btn');
          survivalBtn.classList.remove('disabled-btn');
          executeBtn.classList.remove('disabled-btn');
          mafiaBtn.disabled = false;
          policeBtn.disabled = false;
          doctorBtn.disabled = false;
          mafiaBtn.classList.remove('disabled-btn');
          policeBtn.classList.remove('disabled-btn');
          doctorBtn.classList.remove('disabled-btn');
          console.log(mafiaBtn, policeBtn, doctorBtn);
          socket.emit('UPDATE:MY_INFO', {
            roomId: roomId,
            userId: currentUserId,
          });
          socket.on('myInfo', function (data) {
            sender = data.sender;
            console.log(sender);
          });
        });

        socket.on('NOT:CHAT', function () {
          alert('Î∞§ÏóêÎäî ÎßàÌîºÏïÑÎßå ÎåÄÌôîÌï† Ïàò ÏûàÏäµÎãàÎã§.');
          return;
        });

        socket.on('POLICE:RESULT', function (data) {
          console.log('Í≤∞Í≥º ÏàòÏã† ÏôÑÎ£å');
          appendChatMessage('[Í≤ΩÏ∞∞ Ï°∞ÏÇ¨ Í≤∞Í≥º] ÎåÄÏÉÅÏùò Ïó≠Ìï†: ' + data.role, true);
        });

        // Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ: gameEnd Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Îì±Î°ù
        socket.on('gameEnd', function (data) {
          // Í≤åÏûÑ Ï¢ÖÎ£å Ïù¥Î≤§Ìä∏ ÏàòÏã† Ïãú, Í≤åÏûÑ ÏÉÅÌÉú ÏòÅÏó≠Ïóê Í≤∞Í≥º Î©îÏãúÏßÄ ÌëúÏãú
          appendChatMessage('Í≤åÏûÑ Ï¢ÖÎ£å: ' + data.message);
          document.getElementById('gameStatus').textContent = data.message;
          console.log('Í≤åÏûÑ Ï¢ÖÎ£å Îç∞Ïù¥ÌÑ∞:', data);
        });

        socket.on('NIGHT:BACKGROUND', function (data) {
          console.log('NIGHT:BACKGROUND Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          //ÎèôÏ†êÏãú ÎÑòÏñ¥Ïò¨ Îïå Ìà¨ÌëúÎ≤ÑÌäº ÏßÄÏö∞Í∏∞
          document.getElementById('firstVoteContainer').style.display = 'none';
          // Ï†ÑÏ≤¥ Î∞∞Í≤ΩÏùÄ Í≤ÄÏ†ïÏÉâÏúºÎ°ú
          document.body.style.backgroundColor = 'black';
          // div Î∞∞Í≤ΩÏùÄ ÏàúÏàò Ìù∞ÏÉâ ÎåÄÏã† Ïó∞Ìïú ÌöåÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
          var chatContainer = document.querySelector('.chat-container');
          var occupantContainer = document.querySelector('.occupant-container');
          if (chatContainer) chatContainer.style.backgroundColor = '#e0e0e0';
          if (occupantContainer)
            occupantContainer.style.backgroundColor = '#e0e0e0';
          //sender.isAlive ÏßÄÏ†ï ÌïÑÏöî
          socket.emit('UPDATE:MY_INFO', {
            roomId: roomId,
            userId: currentUserId,
          });
          socket.on('myInfo', function (data) {
            sender = data.sender;
            console.log(sender);
          });
        });

        // VOTE:FIRST:TARGET:EFFECT Ïù¥Î≤§Ìä∏ ÏàòÏã† Ïãú 2Ï∞® Ìà¨Ìëú Î≤ÑÌäº ÌëúÏãú Î∞è ÎåÄÏÉÅ Î≤ÑÌäº blink Ï†ÅÏö©
        socket.on('VOTE:FIRST:TARGET:EFFECT', function (data) {
          console.log('VOTE:FIRST:TARGET:EFFECT Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          var winnerBtn = document.querySelector(
            `.occupant-btn[data-userid="${data.winnerId}"]`,
          );
          if (winnerBtn) {
            winnerBtn.classList.add('blink');
          }
          document.getElementById('firstVoteContainer').style.display = 'none';
          document.getElementById('secondVoteContainer').style.display =
            'block';
        });

        // VOTE:SECOND:DEAD Ïù¥Î≤§Ìä∏ ÏàòÏã† Ïãú, ÎåÄÏÉÅ Î≤ÑÌäºÏùò blink Ìö®Í≥º Ï†úÍ±∞ Î∞è ÎπÑÌôúÏÑ±Ìôî
        socket.on('VOTE:SECOND:DEAD', function (data) {
          console.log('VOTE:SECOND:DEAD Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          var targetId = data.targetId;
          var targetBtn = document.querySelector(
            `.occupant-btn[data-userid="${targetId}"]`,
          );
          if (targetBtn) {
            targetBtn.classList.remove('blink'); // ÍπúÎπ°ÏûÑ Ï†úÍ±∞
            targetBtn.classList.remove('btn-outline-primary');
            targetBtn.classList.add('btn-secondary');
            targetBtn.classList.add('dead'); // dead ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            targetBtn.textContent += 'üíÄ';
            targetBtn.disabled = true;
          }
          document.getElementById('secondVoteContainer').style.display = 'none';
        });

        // VOTE:SECOND:TIE Ïù¥Î≤§Ìä∏ ÏàòÏã† Ïãú, ÎåÄÏÉÅ Î≤ÑÌäºÏùò blink Ìö®Í≥º Ï†úÍ±∞
        socket.on('VOTE:SECOND:TIE', function (data) {
          console.log('VOTE:SECOND:TIE Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          var targetId = data.targetId;
          var targetBtn = document.querySelector(
            `.occupant-btn[data-userid="${targetId}"]`,
          );
          if (targetBtn) {
            targetBtn.classList.remove('blink'); // ÍπúÎπ°ÏûÑ Ï†úÍ±∞
            targetBtn.classList.remove('btn-outline-primary');
          }
          document.getElementById('secondVoteContainer').style.display = 'none';
        });

        // Î∞§ ÏãúÏûë Ïã†Ìò∏ ÏàòÏã† Ïãú Ïó≠Ìï† Î≤ÑÌäº ÌëúÏãú
        socket.on('NIGHT:START:SIGNAL', function (data) {
          console.log('üåô NIGHT:START:SIGNAL Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          appendChatMessage('[SYSTEM] Î∞§ Îã®Í≥ÑÎ°ú Ï†ÑÌôòÎê©ÎãàÎã§...', true);
          document.body.style.backgroundColor = 'black';
          var chatContainer = document.querySelector('.chat-container');
          var occupantContainer = document.querySelector('.occupant-container');
          if (chatContainer) chatContainer.style.backgroundColor = '#2c3e50';
          if (occupantContainer)
            occupantContainer.style.backgroundColor = '#2c3e50';
          document.getElementById('firstVoteContainer').style.display = 'none';
          document.getElementById('secondVoteContainer').style.display = 'none';
          showRoleActionContainer();
        });

        socket.on('ROOM:NIGHT_START', function (data) {
          console.log('üåå ROOM:NIGHT_START Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          appendChatMessage('[SYSTEM] ' + data.message, true);
          document.body.style.backgroundColor = 'black';
          // Îã®Ïàú ÏïàÎÇ¥ Î©îÏãúÏßÄ, Ïó≠Ìï† Î≤ÑÌäºÏùÄ NIGHT:START:SIGNALÏóêÏÑú Ï≤òÎ¶¨
        });

        // Î∞§ Í≤∞Í≥ºÎ•º Î∞õÎäî Ìï®Ïàò.
        socket.off('ROOM:NIGHT_RESULT');
        socket.on('ROOM:NIGHT_RESULT', function (data) {
          console.log('üåô ROOM:NIGHT_RESULT Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);

          // ‚úÖ Î∞§ Í≤∞Í≥º Î©îÏãúÏßÄÎ•º Ï±ÑÌåÖÏ∞ΩÏóê Ï∂îÍ∞Ä
          appendChatMessage(`[SYSTEM] ${data.message}`, true);

          // ‚úÖ ÏÇ¨ÎßùÌïú ÌîåÎ†àÏù¥Ïñ¥ Í∞ïÏ°∞ ÌëúÏãú
          if (data.result && data.result.killedUserId) {
            var killedUserId = data.result.killedUserId;
            var killedUserBtn = document.querySelector(
              `.occupant-btn[data-userid="${killedUserId}"]`,
            );
            if (killedUserBtn) {
              killedUserBtn.style.backgroundColor = '#e74c3c';
              killedUserBtn.style.color = 'white';
              killedUserBtn.classList.add('btn-secondary');
              killedUserBtn.textContent += 'üíÄ';
              killedUserBtn.style.opacity = '0.5'; // opacity 0.5 ÏÑ§Ï†ï
              killedUserBtn.disabled = true;
            }
            appendChatMessage(
              `[SYSTEM] ÌîåÎ†àÏù¥Ïñ¥ ${killedUserId}Í∞Ä Î∞§Ïóê ÏÇ¨ÎßùÌñàÏäµÎãàÎã§.`,
              true,
            );
          }

          // ‚úÖ Í≤ΩÏ∞∞ Ï°∞ÏÇ¨ Í≤∞Í≥º ÌëúÏãú
          if (data.result && data.result.policeResult) {
            if (sender.role === 'police') {
              appendChatMessage(
                `[Í≤ΩÏ∞∞ Ï°∞ÏÇ¨ Í≤∞Í≥º] ÌîåÎ†àÏù¥Ïñ¥ ${data.result.policeResult.targetUserId}Ïùò Ïó≠Ìï†: ${data.result.policeResult.role}`,
                true,
              );
            }
          }

          // ‚úÖ Î∞∞Í≤Ω ÏÉâÏÉÅ ÏõêÎûòÎåÄÎ°ú Î≥ÄÍ≤Ω (Î∞§ Ï¢ÖÎ£å)
          document.body.style.backgroundColor = '#f0f4f8';
          var chatContainer = document.querySelector('.chat-container');
          var occupantContainer = document.querySelector('.occupant-container');
          if (chatContainer) chatContainer.style.backgroundColor = '#ffffff';
          if (occupantContainer)
            occupantContainer.style.backgroundColor = '#ffffff';

          // ‚úÖ Ïó≠Ìï† Î≤ÑÌäº Ïà®Í∏∞Í∏∞
          hideRoleActionContainer();
        });

        // Î∞§ Í≤∞Í≥ºÎ•º ÌÖåÏä§Ìä∏
        socket.on('GAME:RESULT_TEST', function (data) {
          console.log('üåô GAME:RESULT_TEST Ïù¥Î≤§Ìä∏ ÏàòÏã†:', data);
          appendChatMessage(
            '[SYSTEM] Î∞§ ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÏàòÏã† ÎêòÏóàÏäµÎãàÎã§....',
            true,
          );
        });

        // 1Ï∞® Ìà¨Ìëú ÌôïÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document
          .getElementById('voteBtn')
          .addEventListener('click', function () {
            console.log(`1Ï∞®${sender}`);
            if (!sender.isAlive) {
              alert('Ï£ΩÏùÄ ÏÇ¨ÎûåÏùÄ Ìà¨ÌëúÎ•º Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
              return;
            }

            if (!isVotingPhase) {
              alert('ÌòÑÏû¨ Ìà¨ÌëúÍ∞Ä ÏßÑÌñâÎêòÏßÄ ÏïäÎäî ÏãúÍ∏∞ÏûÖÎãàÎã§.');
              return;
            }

            if (!selectedTargetId) {
              alert('Ìà¨ÌëúÌï† ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
              return;
            }
            var voteBtn = document.getElementById('voteBtn');
            voteBtn.disabled = true;
            voteBtn.classList.add('disabled-btn');
            socket.off('VOTE:FIRST');
            socket.emit(
              'VOTE:FIRST',
              {
                roomId: roomId,
                voterId: currentUserId,
                targetId: Number(selectedTargetId),
              },
              function (response) {
                console.log('ÏÑúÎ≤Ñ ÏùëÎãµ ÏàòÏã†:', response);
                if (!response || !response.success) {
                  alert(response?.message || 'ÏÑúÎ≤Ñ ÏùëÎãµÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                  return;
                }

                console.log('1Ï∞® Ìà¨Ìëú ÏôÑÎ£å:', {
                  voterId: currentUserId,
                  targetId: selectedTargetId,
                });
                clearSelection();
              },
            );
          });
        // 2Ï∞® Ìà¨Ìëú: ÏÇ¨ÏÇ¥ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document
          .getElementById('executeBtn')
          .addEventListener('click', function () {
            console.log(`2Ï∞®${sender}`);
            if (!sender.isAlive) {
              alert('Ï£ΩÏùÄ ÏÇ¨ÎûåÏùÄ Ìà¨ÌëúÎ•º Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
              return;
            }

            if (!isVotingPhase) {
              alert('ÌòÑÏû¨ Ìà¨ÌëúÍ∞Ä ÏßÑÌñâÎêòÏßÄ ÏïäÎäî ÏãúÍ∏∞ÏûÖÎãàÎã§.');
              return;
            }

            var executeBtn = document.getElementById('executeBtn');
            var survivalBtn = document.getElementById('survivalBtn');
            executeBtn.disabled = true;
            survivalBtn.disabled = true;
            executeBtn.classList.add('disabled-btn');
            survivalBtn.classList.add('disabled-btn');

            // Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞

            socket.off('VOTE:SECOND');
            socket.emit(
              'VOTE:SECOND',
              {
                roomId: roomId,
                voterId: currentUserId,
                execute: true,
              },
              function (response) {
                console.log('2Ï∞® Ìà¨Ìëú (ÏÇ¨ÏÇ¥) ÏùëÎãµ:', response);
                document.getElementById('secondVoteContainer').style.display =
                  'none';
              },
            );
          });

        // 2Ï∞® Ìà¨Ìëú: ÏÉùÏ°¥ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document
          .getElementById('survivalBtn')
          .addEventListener('click', function () {
            if (!sender.isAlive) {
              alert('Ï£ΩÏùÄ ÏÇ¨ÎûåÏùÄ Ìà¨ÌëúÎ•º Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
              return;
            }

            if (!isVotingPhase) {
              alert('ÌòÑÏû¨ Ìà¨ÌëúÍ∞Ä ÏßÑÌñâÎêòÏßÄ ÏïäÎäî ÏãúÍ∏∞ÏûÖÎãàÎã§.');
              return;
            }

            if (!selectedTargetId) {
              alert('Ìà¨ÌëúÌï† ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
              return;
            }
            var executeBtn = document.getElementById('executeBtn');
            var survivalBtn = document.getElementById('survivalBtn');
            executeBtn.disabled = true;
            survivalBtn.disabled = true;
            executeBtn.classList.add('disabled-btn');
            survivalBtn.classList.add('disabled-btn');

            socket.off('VOTE:SECOND');
            socket.emit(
              'VOTE:SECOND',
              {
                roomId: roomId,
                voterId: currentUserId,
                execute: false,
              },
              function (response) {
                console.log('2Ï∞® Ìà¨Ìëú (ÏÉùÏ°¥) ÏùëÎãµ:', response);
                document.getElementById('secondVoteContainer').style.display =
                  'none';
              },
            );
          });

        function appendChatMessage(message, isRole) {
          var chatMessagesDiv = document.getElementById('chatMessages');
          var messageElement = document.createElement('div');

          if (isRole === 'system_message') {
            messageElement.classList.add('role-message');
          } else if (isRole === 'CHAT:DEAD') {
            messageElement.classList.add('red-message');
          } else if (isRole === 'CHAT:MAFIA') {
            messageElement.classList.add('purple-message');
          }

          messageElement.textContent = message;
          chatMessagesDiv.appendChild(messageElement);

          // Ïä§ÌÅ¨Î°§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
          chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò
        function sendChatMessage() {
          var messageInputElem = document.getElementById('messageInput');
          var message = messageInputElem ? messageInputElem.value : '';
          //var sender =
          if (message.trim() === '') return;
          if (sender.isAlive === false) {
            // Ï£ΩÏùÄ ÏÇ¨ÎûåÏùÄ Î¨¥Ï°∞Í±¥ 'chatDead'
            console.log('Ï£ΩÏùÄÍ≤ΩÏö∞');
            socket.emit('chatDead', {
              roomId: roomId,
              userId: currentUserId,
              message: message,
            });
            if (messageInputElem) {
              messageInputElem.value = '';
            }
          } else if (sender.role === 'mafia') {
            // ÎßàÌîºÏïÑÏù¥Î©¥ÏÑú ÏÇ¥ÏïÑÏûàÎäî Í≤ΩÏö∞
            console.log('ÎßàÏÇ¥');
            socket.emit('chatMafia', {
              roomId: roomId,
              userId: currentUserId,
              message: message,
            });
            if (messageInputElem) {
              messageInputElem.value = '';
            }
          } else if (
            sender.role === 'citizen' ||
            sender.role === 'doctor' ||
            sender.role === 'police'
          ) {
            console.log('ÏãúÎØº Ï±ÑÌåÖ');
            socket.emit('chatCitizen', {
              roomId: roomId,
              userId: currentUserId,
              message: message,
            });
            if (messageInputElem) {
              messageInputElem.value = '';
            }
          } else {
            console.log('ÏùºÎ∞òÏ±ÑÌåÖ');
            socket.emit('chatMessage', {
              roomId: roomId,
              userId: currentUserId,
              message: message,
            });
            if (messageInputElem) {
              messageInputElem.value = '';
            }
          }
        }

        // Ï†ëÏÜç Ïù∏Ïõê ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateOccupantList(roomData) {
          console.log('Ï†ëÏÜç Ïù∏Ïõê ÏóÖÎç∞Ïù¥Ìä∏:', roomData);

          var occupantListDiv = document.getElementById('occupantList');
          var myOccupantDiv = document.getElementById('myOccupantDiv');

          occupantListDiv.innerHTML = ''; // ÏùºÎ∞ò Ïú†Ï†Ä Î¶¨Ïä§Ìä∏ Ï¥àÍ∏∞Ìôî
          myOccupantDiv.innerHTML = ''; // Î≥∏Ïù∏ ÌëúÏãú ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî

          var players = [];
          try {
            players =
              typeof roomData.players === 'string'
                ? JSON.parse(roomData.players)
                : roomData.players;
          } catch (error) {
            players = [];
          }

          var otherPlayers = [];
          var currentPlayer = null;

          // Î≥∏Ïù∏Í≥º Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥Î•º Î∂ÑÎ¶¨
          players.forEach(function (player) {
            if (player.id === currentUserId) {
              currentPlayer = player;
            } else {
              otherPlayers.push(player);
            }
          });

          // Îã§Î•∏ ÌîåÎ†àÏù¥Ïñ¥ Î®ºÏ†Ä Ï∂îÍ∞Ä (Ï†ëÏÜç ÏàúÏÑú Ïú†ÏßÄ)
          otherPlayers.forEach(function (player) {
            var btn = document.createElement('button');
            btn.className = 'btn btn-outline-primary occupant-btn';
            btn.textContent = 'ÏÇ¨Ïö©Ïûê ' + player.id;
            btn.dataset.userid = player.id;
            btn.addEventListener('click', function () {
              document
                .querySelectorAll('.occupant-btn:not([disabled])')
                .forEach(function (b) {
                  b.classList.remove('selected');
                });
              btn.classList.add('selected');
              selectedTargetId = Number(btn.dataset.userid);
              console.log('ÏÑ†ÌÉùÎêú ÎåÄÏÉÅ:', selectedTargetId);
            });
            occupantListDiv.appendChild(btn);
          });

          // Î≥∏Ïù∏ Î≤ÑÌäºÏùÑ ÏÉàÎ°úÏö¥ divÏóê Ï∂îÍ∞Ä (ÌïòÎã® Í≥†Ï†ï)
          if (currentPlayer) {
            var myBtn = document.createElement('button');
            myBtn.className = 'btn btn-secondary occupant-btn';
            var roleText = currentPlayer.role
              ? ` - [${currentPlayer.role}]`
              : ''; // Ïó≠Ìï†Ïù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            myBtn.textContent = `üë§ ÎÇò (ÏÇ¨Ïö©Ïûê ${currentUserId})${roleText}`;
            myBtn.disabled = true;
            myOccupantDiv.appendChild(myBtn);
          }
        }

        // ÏÑ†ÌÉù Ìï¥Ï†ú Ìï®Ïàò
        function clearSelection() {
          var allBtns = document.querySelectorAll('.occupant-btn');
          allBtns.forEach(function (b) {
            b.classList.remove('selected');
          });
          selectedTargetId = null;
        }

        // Î∞§ Î°úÏßÅ Ï≤òÎ¶¨ Ìï®Ïàò ÎßàÌîºÏïÑ
        function handleMafiaAction() {
          if (!selectedTargetId) {
            alert('ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
          }
          socket.off('ACTION:MAFIA_TARGET');
          socket.emit(
            'ACTION:MAFIA_TARGET',
            {
              roomId,
              userId: currentUserId,
              targetUserId: Number(selectedTargetId),
            },
            function (response) {
              if (response && response.success) {
                appendChatMessage('[ÎßàÌîºÏïÑ] Îä•Î†• ÏÇ¨Ïö© ÏôÑÎ£å!', true);
                hideRoleActionContainer();
                clearSelection();
                checkNightActionsCompleted(); // üî• Ï∂îÍ∞ÄÎê®
              } else {
                alert(response?.message || 'Îä•Î†• ÏÇ¨Ïö© Ïã§Ìå®');
              }
            },
          );
          var mafiaBtn = document.getElementById('mafiaActionBtn');
          mafiaBtn.disabled = true;
          mafiaBtn.classList.add('disabled-btn');
        }

        // Í≤ΩÏ∞∞ Ìï®Ïàò
        function handlePoliceAction() {
          if (!selectedTargetId) {
            alert('ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
          }
          socket.off('ACTION:POLICE_TARGET');
          socket.emit(
            'ACTION:POLICE_TARGET',
            {
              roomId,
              userId: currentUserId,
              targetUserId: Number(selectedTargetId),
            },
            function (response) {
              if (response && response.success) {
                appendChatMessage('[Í≤ΩÏ∞∞] Îä•Î†• ÏÇ¨Ïö© ÏôÑÎ£å!', true);
                hideRoleActionContainer();
                clearSelection();
                checkNightActionsCompleted(); // üî• Ï∂îÍ∞ÄÎê®
              } else {
                alert(response?.message || 'Îä•Î†• ÏÇ¨Ïö© Ïã§Ìå®');
              }
            },
          );
          var policeBtn = document.getElementById('policeActionBtn');
          policeBtn.disabled = true;
          policeBtn.classList.add('disabled-btn');
        }

        // ÏùòÏÇ¨ Ìï®Ïàò
        function handleDoctorAction() {
          if (!selectedTargetId) {
            alert('ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
          }
          socket.off('ACTION:DOCTOR_TARGET');
          socket.emit(
            'ACTION:DOCTOR_TARGET',
            {
              roomId,
              userId: currentUserId,
              targetUserId: Number(selectedTargetId),
            },
            function (response) {
              if (response && response.success) {
                appendChatMessage('[ÏùòÏÇ¨] Îä•Î†• ÏÇ¨Ïö© ÏôÑÎ£å!', true);
                hideRoleActionContainer();
                clearSelection();
                checkNightActionsCompleted(); // üî• Ï∂îÍ∞ÄÎê®
              } else {
                alert(response?.message || 'Îä•Î†• ÏÇ¨Ïö© Ïã§Ìå®');
              }
            },
          );
          var doctorBtn = document.getElementById('doctorActionBtn');
          doctorBtn.disabled = true;
          doctorBtn.classList.add('disabled-btn');
        }

        // Î∞§ Î°úÏßÅ Ïó≠Ìï†Î≥Ñ Î≤ÑÌäº Ìï∏Îì§Îü¨ Î∂ÄÏ∞© (Ìïú Î≤àÎßå)
        function attachRoleActionHandlers() {
          document
            .getElementById('mafiaActionBtn')
            .addEventListener('click', handleMafiaAction);
          document
            .getElementById('policeActionBtn')
            .addEventListener('click', handlePoliceAction);
          document
            .getElementById('doctorActionBtn')
            .addEventListener('click', handleDoctorAction);
        }
        attachRoleActionHandlers();

        // Î∞§ Î°úÏßÅ Ïó≠Ìï† Î≤ÑÌäº Ïª®ÌÖåÏù¥ÎÑà Í¥ÄÎ†® Ìï®Ïàò
        function showRoleActionContainer() {
          var container = document.getElementById('roleActionContainer');
          container.style.display = 'block';
          document.getElementById('mafiaActionBtn').style.display = 'none';
          document.getElementById('policeActionBtn').style.display = 'none';
          document.getElementById('doctorActionBtn').style.display = 'none';
          console.log('showRoleActionContainer, currentUserRole:', sender.role);
          if (sender.role === 'mafia') {
            document.getElementById('mafiaActionBtn').style.display = 'block';
            appendChatMessage(
              '[ÎßàÌîºÏïÑ] Î∞§Ïù¥ ÎêòÏóàÏäµÎãàÎã§. Ï†úÍ±∞Ìï† ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',
              true,
            );
          } else if (sender.role === 'police') {
            document.getElementById('policeActionBtn').style.display = 'block';
            appendChatMessage(
              '[Í≤ΩÏ∞∞] Î∞§Ïù¥ ÎêòÏóàÏäµÎãàÎã§. Ï°∞ÏÇ¨Ìï† ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',
              true,
            );
          } else if (sender.role === 'doctor') {
            document.getElementById('doctorActionBtn').style.display = 'block';
            appendChatMessage(
              '[ÏùòÏÇ¨] Î∞§Ïù¥ ÎêòÏóàÏäµÎãàÎã§. Î≥¥Ìò∏Ìï† ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',
              true,
            );
          } else {
            appendChatMessage(
              '[SYSTEM] Î∞§Ïù¥ ÎêòÏóàÏäµÎãàÎã§. Í≤∞Í≥ºÎ•º Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.',
              true,
            );
          }
        }
        //Î∞§ Î°úÏßÅ Í¥ÄÎ†® Ìï®Ïàò
        function hideRoleActionContainer() {
          document.getElementById('roleActionContainer').style.display = 'none';
        }
        // Î∞§ Ïï°ÏÖò Ï≤¥ÌÅ¨ Ìï®Ïàò -> Ïã§ÌñâÏù¥ ÏïàÎê®.
        function checkNightActionsCompleted() {
          console.log('checkNightActionsCompleted');
          socket.off('CHECK:NIGHT_ACTIONS');
          socket.emit(
            'CHECK:NIGHT_ACTIONS',
            { roomId: roomId },
            function (response) {
              console.log('CHECK:NIGHT_ACTIONS ÏùëÎãµ:', response);
              if (response.allActionsCompleted) {
                console.log(
                  'üî• Î™®Îì† Î∞§ Ïï°ÏÖò ÏôÑÎ£åÎê®. `PROCESS:NIGHT_RESULT` ÏöîÏ≤≠!',
                );
                socket.emit('PROCESS:NIGHT_RESULT', { roomId: roomId });
              }
            },
          );
        }
      };
    </script>
  </body>
</html>
